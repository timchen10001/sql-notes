```sql
----------------------------------------------------
-- timestamp with time zone
create table time_zone (
	id serial primary key,
	timestamp_with_time_zone timestamp with time zone not null
);

-- correct usage
insert into time_zone
(timestamp_with_time_zone)
values
('2004-10-19 10:23:54+02');

select * from time_zone;

-- error 
insert into time_zone
(timestamp_with_time_zonde)
values
('2004-12-20')


select '2018-03-11 02:30'::timestamptz;
select '2018-03-11'::timestamptz;
select 'now'::timestamptz;
select 'yesterday'::timestamptz;

-- correct
insert into time_zone
(timestamp_with_time_zone)
values
('2004-12-20'::timestamptz)

select * from time_zone;

------------------------ Postgres Tricks ----------------------------

-- 1. Insert Multiple Rows In One Statement
insert into time_zone
(timestamp_with_time_zone)
values
('now'::timestamptz),
('today'::timestamptz),
('yesterday'::timestamptz),
('epoch'::timestamptz),
('tomorrow'::timestamptz),
('infinity'::timestamptz),
('-infinity'::timestamptz);

select * from time_zone;


-- 2. Insert a Row and Return Automatically-assigned Values
create table items (
	id serial primary key,
	name text not null,
	created_at timestamptz default now()
);

insert into items
(name)
values
('item1'),
('item2'),
('item3'),
('item4')
returning id, name, created_at;


-- 3. Autogenerated UUID Primary Keys rather than serial(auto-incrementing 4bytes integer) or IDENTITY
select * from pg_extension;
select * from pg_available_extensions;

-- https://www.postgresql.org/docs/9.4/uuid-ossp.html
create extension if not exists "uuid-ossp";

select uuid_generate_v4();

create table exsamples (
	id uuid default uuid_generate_v4(),
	name text not null
);

insert into exsamples
(name)
values
('sample1'),
('sample2'),
('sample3'),
('sample4'),
('sample5')
returning id, name;

drop extension "uuid-ossp";


-- 4. Insert If Not Existing, Update Otherwise
create table parameters (
    id text primary key,
    value text
);

insert into parameters (id, value) values ('port', '5432');

  -- when "key" causes a constraint violation, update the "value"
insert into parameters
(id, value) 
values ('port', '3306')
on conflict (id) do
update set value = EXCLUDED.value
returning id, value;


-- 5. Copy Rows From One Table Into Another

-- copy between tables with similar columns
create table quests (id serial primary key, progress integer default 0); -- origin
insert into quests (progress) values (20), (40), (60), (100), (100), (100);

create table pending_quests (id serial primary key, progress integer default 0); -- to move
insert into pending_quests
select * from quests where progress > 30
on conflict (id) do
update set progress = EXCLUDED.progress
returning id, progress;

-- supply some values from another table, some directly
create table archived_quests (
	id serial primary key,
	progress integer default 0,
	archival_date timestamp not null
);

insert into archived_quests
select
  * from quests,
  now() as archival_date
  where progress = 100
 returning id, progress, archival_date;

drop table archived_quests;


-- 6. Move Rows From One Table Into Another
-- move yet-to-start todo items from 2020 to 2021
with yet_to_starts as (
    delete from todos_2020
          where not started
      returning *
)
insert into todos_2021
select * from yet_to_starts;

-- 7. Update a Few Random Rows and Return The Updated Ones
with lucky_few as (
	select id
	from employees
	order by random()
	limit 5
)
update employees
set bonus = bonus + 100
where id in (select id from luck_few)
returning id;

-- 8. Create a Table Just Like Another Table
-- https://www.postgresql.org/docs/current/sql-createtable.html
create table time_zone_copy (like time_zone); -- only same columns
select * from time_zone_copy;

-- By default this does not create similar indexes, constraints, defaults etc. To do that, ask Postgres explicitly:
create table time_zone_copy_precise (like time_zone including all); -- totaly cloning
select * from time_zone_copy_precise;


-- 9. Extract a Random Set of Rows Into Another Table
-- copy 10% of today's purchases into portfolio table
insert into portfolio
select * from purchases tablesample bernoulli(10)
where transaction_date = CURRENT_DATE;
-- The system tablesampling method is faster, but does not return a uniform distribution. -- 均勻分佈
-- https://www.postgresql.org/docs/current/sql-select.html#SQL-FROM

-- 10. Create a Table From a Select Query
create table protfolio as
      select *
        from purchases
 tablesample bernoulli(10)
       where transaction_date = CURRENT_DATE;
```
